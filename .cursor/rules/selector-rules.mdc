---

# FUNCTION SELECTOR RULES

Function selector hesaplama hatalarÄ±nÄ± Ã¶nlemek iÃ§in kritik kurallar.

## YASAK YÃ–NTEMLER âŒ

### Manual Hash Hesaplama
```javascript
// âŒ YANLIÅ - Node.js crypto ile manuel hesaplama
const crypto = require('crypto');
const hash = crypto.createHash('sha3-256').update('getGreeting()').digest('hex');
const selector = '0x' + hash.slice(0, 8); // YANLIÅ SONUÃ‡!
```

### Hardcoded Selectors
```typescript
// âŒ YANLIÅ - Manuel olarak tahmin edilen selectorlar
const testFacetSelectors = [
  "0x76a631c0", // getGreeting() - YANLIÅ!
  "0x62738998", // getCallerInfo() - YANLIÅ!
];
```

## DOÄRU YÃ–NTEMLER âœ…

### 1. Hardhat Contract Interface KullanÄ±mÄ±
```typescript
// âœ… DOÄRU - Hardhat Contract Factory interface
const TestFacet = await ethers.getContractFactory("TestFacet");
const iface = TestFacet.interface;

const selector = iface.getFunction("getGreeting")?.selector;
console.log("Correct selector:", selector); // 0xfe50cc72
```

### 2. Otomatik Selector Collection
```typescript
// âœ… DOÄRU - TÃ¼m fonksiyonlar iÃ§in otomatik toplama
const TestFacet = await ethers.getContractFactory("TestFacet");
const iface = TestFacet.interface;

const functions = ["getGreeting", "getCallerInfo", "getSecretMessage", "getMagicNumber"];
const selectors: string[] = [];

functions.forEach(funcName => {
  const selector = iface.getFunction(funcName)?.selector;
  if (selector) {
    selectors.push(selector);
  }
});
```

### 3. Helper Script ile Verification
```typescript
// âœ… DOÄRU - Selector doÄŸrulama scripti
async function getCorrectSelectors(contractName: string, functionNames: string[]) {
  const Contract = await ethers.getContractFactory(contractName);
  const iface = Contract.interface;
  
  const selectors: string[] = [];
  functionNames.forEach(funcName => {
    const selector = iface.getFunction(funcName)?.selector;
    if (selector) {
      console.log(`  ${funcName}(): ${selector}`);
      selectors.push(selector);
    }
  });
  
  return selectors;
}
```

## HATA TESPÄ°TÄ° ğŸ”

### Diamond'da "Function does not exist" HatasÄ±
Bu hata genellikle yanlÄ±ÅŸ selector kullanÄ±mÄ±ndan kaynaklanÄ±r:

```
âŒ execution reverted: BraveUniverseDiamond: Function does not exist
```

**Ã‡Ã¶zÃ¼m:**
1. Selector'larÄ± hardhat interface ile tekrar hesapla
2. Diamond'daki mevcut selector'larÄ± kontrol et
3. YanlÄ±ÅŸ selector'larÄ± kaldÄ±r, doÄŸrularÄ±nÄ± ekle

### Verification Komutu
```bash
# Diamond'daki mevcut selector'larÄ± kontrol et
npx hardhat run scripts/verify-diamond.ts --network luksoTestnet
```

## WORKFLOW ğŸ“‹

### Yeni Facet Ekleme SÃ¼reci
1. **Contract yazmadan Ã¶nce**: Fonksiyon isimlerini planla
2. **Contract yazdÄ±ktan sonra**: Compile et
3. **Selector hesapla**: Hardhat interface kullan
4. **DiamondCut hazÄ±rla**: DoÄŸru selector'larla
5. **Test et**: Ekleme sonrasÄ± fonksiyonlarÄ± Ã§aÄŸÄ±r
6. **Verify et**: Diamond verification script Ã§alÄ±ÅŸtÄ±r

### Acil Durum Temizleme
```typescript
// YanlÄ±ÅŸ selector'larÄ± temizlemek iÃ§in
const removeDiamondCut = [{
  facetAddress: ethers.ZeroAddress,
  action: 2, // Remove
  functionSelectors: ["0xYANLIS_SELECTOR1", "0xYANLIS_SELECTOR2"]
}];
```

## Ã–NEMLI NOTLAR âš ï¸

- Node.js `crypto.createHash('sha3-256')` **Ethereum keccak256 ile aynÄ± deÄŸil**
- Manuel hesaplama **asla gÃ¼venilir deÄŸil**
- Hardhat interface **her zaman doÄŸru sonuÃ§ verir**
- Selector Ã§akÄ±ÅŸmasÄ± durumunda Diamond **ilk eklenen fonksiyonu kullanÄ±r**

âœ… **KURAL**: Selector hesaplamada sadece Hardhat Contract Interface kullan!